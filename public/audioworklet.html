<html>
  <head>
    <title>Sine wave audio with Audio worklet</title>
    <!-- <base href="/" /> -->
    <style>
      #buttons-container {
        position: absolute;
        top: 100px;
        left: 100px;
      }

      button {
        width: 100px;
        height: 50px;
      }
    </style>
  </head>

  <body>
    <div id="buttons-container">
      <button onclick="play()" id="playbtn">Play</button>
      <!-- <audio id="audio" controls onplay="playerStarted()" ontimeupdate="timeupdate(this)">

            <source src="./50910__rutgermuller__in-car-driving.wav">
            Your browser does not support the audio element.
        </audio> -->
      <button onclick="pause()" id="pausebtn">Stop</button>

      <p id="result"></p>
      <p id="result1"></p>
      <p id="result2"></p>
    </div>

    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
    <script src="./buffer.js"></script>
    <script>
      function timeupdate(e) {
        console.log("updated time");
        console.log(e.currentTime);
      }

      function playerStarted(e) {
        console.log("player started");
      }
      var context = new (window.AudioContext || window.webkitAudioContext)();
      var bufferLoader;

      var audio = document.getElementById("audio");

      bufferLoader = new BufferLoader(
        context,
        ["./50910__rutgermuller__in-car-driving.wav"],
        finishedLoading
      );

      bufferLoader.load();

      var source1;

      function finishedLoading(bufferList) {
        source1 = context.createBufferSource();
        source1.buffer = bufferList[0];
      }

      function play() {


        // source1.connect(context.destination);
        // source1.start(0);
        // let ts = context.getOutputTimestamp();
        // $("#result").text(`Base latency: ${context.baseLatency}`)
        // $("#result1").text(`Context time: ${ts.contextTime}`)
        // $("#result2").text(`Performance time: ${ts.performanceTime}`)

              context.audioWorklet.addModule("bypass-processor.js").then(_ => {
                const bypasser = new AudioWorkletNode(context, 'bypass-processor');
                source1.connect(bypasser).connect(context.destination);
                source1.start(0);
                let ts = context.getOutputTimestamp();
                $("#result").text(`Worklet : Base latency: ${context.baseLatency}`)
                $("#result1").text(`Worklet: Context time: ${ts.contextTime}`)
                $("#result2").text(`Worklet: Performance time: ${ts.performanceTime}`)
          });
      }

      //   audio.addEventListener("play", () => {
      //     const track = context.createMediaElementSource(audio);
      //     track.connect(context.destination);

      //     // let ts = context.getOutputTimestamp()
      //     // console.log('Context time: ' + ts.contextTime + ' | Performance time: ' + ts.performanceTime);



      function pause() {
        source1.stop(0);
      }
    </script>
  </body>
</html>
